name: Build for legacy GLIBC

on:
  schedule:
    - cron: "0 6 * * *" # Daily at 6:00 UTC
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (e.g. v1.1.8). Leave empty to build latest upstream tag."
        required: false
        type: string

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
      should_build: ${{ steps.resolve.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag to build
        id: resolve
        run: |
          if [[ -n "${{ inputs.tag }}" ]]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "Using manually specified tag: ${{ inputs.tag }}"
            exit 0
          fi

          # Get latest upstream tag
          LATEST_TAG=$(curl -sf https://api.github.com/repos/anomalyco/opencode/releases/latest | jq -r '.tag_name')
          echo "Latest upstream tag: $LATEST_TAG"

          if [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]]; then
            echo "No tags found"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if we already have a release for this tag
          RELEASE_EXISTS=$(gh release view "$LATEST_TAG" --json tagName 2>/dev/null || echo "")
          if [[ -n "$RELEASE_EXISTS" ]]; then
            echo "Release for $LATEST_TAG already exists, skipping"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          else
            echo "New tag found: $LATEST_TAG"
            echo "tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  build:
    needs: check
    if: needs.check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build binary
        run: |
          docker build \
            --build-arg VERSION=${{ needs.check.outputs.tag }} \
            --output type=local,dest=./dist \
            ./build/legacy-glibc

      - name: Create tarball
        run: |
          cd dist
          tar -czvf opencode-${{ needs.check.outputs.tag }}-linux-x64-legacy-glibc.tar.gz opencode

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencode-${{ needs.check.outputs.tag }}-linux-x64-legacy-glibc
          path: dist/opencode-${{ needs.check.outputs.tag }}-linux-x64-legacy-glibc.tar.gz

      - name: Create release
        run: |
          gh release create "${{ needs.check.outputs.tag }}" \
            --title "OpenCode ${{ needs.check.outputs.tag }} (Legacy GLIBC)" \
            --notes "OpenCode ${{ needs.check.outputs.tag }} built with bundled musl libraries for systems with older GLIBC versions.

          ## Installation
          1. Using mise:

            \`\`\`bash
            mise install github:pedropombeiro/opencode-legacy-glibc@${{ needs.check.outputs.tag }}
            \`\`\`

          2. Manual:
            1. Download and extract the tarball
            2. Run \`./opencode/bin/opencode\`

          Based on upstream release: https://github.com/anomalyco/opencode/releases/tag/${{ needs.check.outputs.tag }}" \
            dist/opencode-${{ needs.check.outputs.tag }}-linux-x64-legacy-glibc.tar.gz
        env:
          GH_TOKEN: ${{ github.token }}
